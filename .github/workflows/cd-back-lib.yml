name: Back lib CD

on:
  workflow_call:
    secrets:
      CARGO_REGISTRY_TOKEN:
        required: true

jobs:
  publish_release:
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact from CI
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: target/release/

      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false

      - uses: dtolnay/rust-toolchain@stable

      - name: Install convco & cargo-release (cached if available)
        run: |
          if ! command -v convco &> /dev/null; then cargo install convco; fi
          if ! command -v cargo-release &> /dev/null; then cargo install cargo-release; fi

      - name: Validate commit formatting
        run: git log -1 --pretty=%B | convco check --from-stdin

      - name: Detect bump type (major/minor/patch)
        id: bump
        run: |
          bump_type=$(convco version --bump)
          echo "BUMP_TYPE=$bump_type" >> $GITHUB_OUTPUT
          echo "Version bump detected: $bump_type"

      - name: Run cargo-release with bump level
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo release \
            --execute \
            --no-confirm \
            ${{ steps.bump.outputs.BUMP_TYPE }}