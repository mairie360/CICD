name: Back lib CD

on:
  workflow_call:
    secrets:
      CARGO_REGISTRY_TOKEN:
        required: true

jobs:
  publish_release:
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact from CI
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: target/release/

      - name: Setup repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false

      - uses: dtolnay/rust-toolchain@stable

      - name: Install convco & cargo-release
        run: |
          cargo install convco
          cargo install cargo-release

      - name: Validate commit formatting (Conventional Commits)
        run: git log -1 --pretty=%B | convco check --from-stdin

      - name: Detect bump type (major/minor/patch)
        id: bump
        run: |
          bump_type=$(convco version --bump-style)
          echo "BUMP_TYPE=$bump_type" >> $GITHUB_OUTPUT
          echo "Version bump detected: $bump_type"

      - name: Run cargo-release
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo release \
            --level ${{ steps.bump.outputs.BUMP_TYPE }} \
            --no-confirm
