name: Back lib CICD

on:
  workflow_call:
    secrets:
      CARGO_REGISTRY_TOKEN:
        required: true

jobs:
  dependencies:
    name: Setup & Fetch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Download Dependencies
        run: cargo fetch

      - name: Pre-compile dependencies
        run: cargo check --release

  lint:
    name: Check lint
    runs-on: ubuntu-latest
    needs: dependencies
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Run lint_check
        uses: actions-rs/cargo@v1
        with:
          command: lint_check
  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: target/release/
          retention-days: 1

  unit_test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [build, lint]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Run Rust Tests
        run: cargo test --release
    
  publish_release:
    if: github.ref == 'refs/heads/main'
    needs: unit_test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          clean: false

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Install convco & cargo-release (cached if available)
        run: |
          if ! command -v convco &> /dev/null; then cargo install convco; fi
          if ! command -v cargo-release &> /dev/null; then cargo install cargo-release; fi

      - name: Configure Git identity for tagging
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate commit formatting
        run: git log -1 --pretty=%B | convco check --from-stdin

      - name: Detect bump type (major/minor/patch)
        id: bump
        run: |
          bump_type=$(convco version --bump || echo "patch")
          echo "BUMP_TYPE=$bump_type" >> $GITHUB_OUTPUT
          echo "Version bump detected: $bump_type"

      - name: Run cargo-release with bump level
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo release \
            --execute \
            --no-confirm \
            ${{ steps.bump.outputs.BUMP_TYPE }}
